<!DOCTYPE html>
<html>

<head>
    <title>Simple Draw Test</title>
    <style>
        body {
            font-family: Arial;
            padding: 20px;
            background: #f5f5f5;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
        }

        h1 {
            color: #333;
        }

        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }

        .success {
            background: #d4edda;
            color: #155724;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
        }

        .info {
            background: #d1ecf1;
            color: #0c5460;
        }

        canvas {
            border: 2px solid #333;
            display: block;
            margin: 20px 0;
            background: white;
            cursor: crosshair;
        }

        button {
            padding: 10px 20px;
            margin: 5px;
            font-size: 16px;
            cursor: pointer;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
        }

        button:hover {
            background: #0056b3;
        }

        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üé® Simple Drawing Test</h1>

        <div id="authStatus" class="status info">Checking authentication...</div>

        <h2>Instructions</h2>
        <p>1. Draw something on the canvas below</p>
        <p>2. Click "Submit" to send it to the server</p>
        <p>3. Watch the logs below for errors</p>

        <canvas id="myCanvas" width="400" height="300"></canvas>

        <button onclick="clearCanvas()">Clear Canvas</button>
        <button onclick="testDraw()">Test (Draw Circle)</button>
        <button onclick="submitDraw()">Submit Drawing</button>

        <h3>Logs:</h3>
        <div id="logs" class="log">Ready...</div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://icyrucuuitdxivcpyhlg.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImljeXJ1Y3V1aXRkeGl2Y3B5aGxnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk2NjM0NzAsImV4cCI6MjA4NTIzOTQ3MH0.96egdfcPHnI7hW64-5rvr4IsSfoZ9YZVtBgtVY2Pwf4';

        const canvas = document.getElementById('myCanvas');
        const ctx = canvas.getContext('2d');
        const logsDiv = document.getElementById('logs');
        const authStatus = document.getElementById('authStatus');

        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;
        let supabase = null;
        let currentToken = null;

        function log(msg, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const line = `[${timestamp}] ${msg}`;
            console.log(line);
            logsDiv.innerHTML += line + '<br>';
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }

        function initCanvas() {
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = '#2d5016';
            ctx.lineWidth = 3;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            log('Canvas initialized', 'success');
        }

        function clearCanvas() {
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            log('Canvas cleared');
        }

        function testDraw() {
            ctx.fillStyle = '#2d5016';
            ctx.beginPath();
            ctx.arc(100, 100, 30, 0, Math.PI * 2);
            ctx.fill();
            log('Test circle drawn', 'success');
        }

        function drawLine(fromX, fromY, toX, toY) {
            ctx.beginPath();
            ctx.moveTo(fromX, fromY);
            ctx.lineTo(toX, toY);
            ctx.stroke();
        }

        function startDrawing(e) {
            isDrawing = true;
            const rect = canvas.getBoundingClientRect();
            lastX = e.clientX - rect.left;
            lastY = e.clientY - rect.top;
            log(`Start drawing at (${Math.round(lastX)}, ${Math.round(lastY)})`);
        }

        function draw(e) {
            if (!isDrawing) return;
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            drawLine(lastX, lastY, x, y);
            lastX = x;
            lastY = y;
        }

        function stopDrawing() {
            if (isDrawing) {
                isDrawing = false;
                log('Stopped drawing');
            }
        }

        async function submitDraw() {
            log('Submitting drawing...');

            if (!currentToken) {
                log('ERROR: No token available', 'error');
                return;
            }

            try {
                const imageData = canvas.toDataURL('image/png');
                log(`Image data length: ${imageData.length}`);

                const response = await fetch('/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentToken}`
                    },
                    body: JSON.stringify({ image: imageData })
                });

                log(`Server response status: ${response.status}`);

                const data = await response.json();

                if (response.ok) {
                    log('SUCCESS: Plant created!', 'success');
                    log(`Plant ID: ${data.id}`);
                } else {
                    log(`ERROR: ${data.error || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                log(`EXCEPTION: ${error.message}`, 'error');
            }
        }

        // Setup canvas events
        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseout', stopDrawing);

        // Initialize
        (async () => {
            try {
                // Initialize Supabase
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                log('Supabase initialized');

                // Get session
                const { data: { session } } = await supabase.auth.getSession();

                if (session) {
                    currentToken = session.access_token;
                    authStatus.innerHTML = `<strong>‚úÖ Logged in as:</strong> ${session.user.email}`;
                    authStatus.className = 'status success';
                    log(`Authenticated: ${session.user.email}`, 'success');
                } else {
                    authStatus.innerHTML = '<strong>‚ùå Not authenticated</strong> - Please <a href="/login">login first</a>';
                    authStatus.className = 'status error';
                    log('ERROR: Not authenticated', 'error');
                }

                // Initialize canvas
                initCanvas();

            } catch (error) {
                log(`INIT ERROR: ${error.message}`, 'error');
            }
        })();
    </script>
</body>

</html>